# Send mail as an impersonated user using Microsoft Graph API

Take control of your email appearance by using the Microsoft Graph API to send emails for you. Upload your own HTML templates into Rewst, and use them with the Microsoft Graph action. In the template, reference variables from the workflow to report on data gathered from workflows. The HTML Template lets you brand the email with your own custom logos and styling.

## Prerequisites for impersonated email send

* The [Microsoft Cloud Integration Bundle](https://app.rewst.io/organizations/b6e6c7b9-ff6e-4fff-a875-dfcb6ffc2c2d/integrations/bundles/microsoft_cloud) must be setup, and working.
* The user selected to send the email must exist in the Microsoft365 tenant called in the workflow.

{% hint style="success" %}
A note about customer context:

If the workflow is running in the customer child organization, you can't send the email from the top level (MSP) domain. The email you send from needs to exist in the tenant the call is being made from. This can make implementing the graph send mail challenging for some workflows. If needed, you can do this by using completion handlers to send the email, instead of doing it within the primary workflow. This will allow you to send from the top level domain, regardless of the context the workflow runs in.
{% endhint %}

## Set up the Microsoft Graph send mail action

1. In the workflow builder, search for the action send mail as impersonated user.\
   \
   ![An image of the Send Mail as Impersonated User action, retrieved from a search bar.](<../../../../../.gitbook/assets/Screenshot 2025-01-16 at 5.05.46 PM.png>)
2. Drag the Microsoft Graph action onto the canvas.&#x20;
3.  Fill out the required parameters, including:

    1. Subject
    2. User ID (AAD ID of sender)
       1. We recommend you set this as an Organizational variable
    3. Message Content
       1. HTML Templates can be used here, as well as plain text
    4. Message Content Type
       1. This should match the type of the above content
    5. To Recipient
       1. An array of recipients

    Other optional parameters include but are not limited to:

    * File attachments
      * Base 64 encoded file attachments. This could be a CSV generated by the workflow
    * Read Receipt
    * CC & BCC
    * Reply To

<figure><img src="../../../../../.gitbook/assets/Screenshot 2025-01-16 at 5.06.56 PM.png" alt="An image of the blank parameters menu for the Microsoft Graph action, ready to be filled out." width="281"><figcaption><p>Find the parameters menu on the <br>right side of your screen.</p></figcaption></figure>

{% hint style="info" %}
**Tips**

* When used in conjunction with our core create webhook and await webhook actions, you can embed webhook links in the HTML message template for approval-related tasks.
* Use free tools such as VS Code to render HTML for testing and creating templates.
* Use Jinja in the HTML template to render data contained within the workflow.
{% endhint %}



## Example HTML template for new user approval

<figure><img src="../../../../../.gitbook/assets/ApprovalRequest.png" alt="A screen captured image of a sample HTML template to send in a custom email"><figcaption></figcaption></figure>



You can embed your own logos in the HTML template. For example, the Rewst logo above is coded in the body:

<figure><img src="../../../../../.gitbook/assets/ApprovalJinja.png" alt="A screen capture of a snippet of HTML code showing how an image logo can be embedded into the template"><figcaption><p>Example HTML, with logo embedded in the code</p></figcaption></figure>

